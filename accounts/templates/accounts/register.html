{% extends "aether_notes/base.html" %}
{% block title %}Register • Aether{% endblock %}

{% block content %}
<h2 style="margin-top:0">Create Account</h2>
<div class="twofactor-wrapper">
  <form method="post" novalidate>
    {% csrf_token %}
    <div class="form-row">
      <label for="id_username">Username</label>
      {{ form.username }}
      <div id="username_status" class="hint"></div>
      {% if form.username.errors %}
        <ul class="twofactor-messages">
          {% for e in form.username.errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_password1">Password</label>
      {{ form.password1 }}
      {% if form.password1.errors %}
        <ul class="twofactor-messages">
          {% for e in form.password1.errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    <div class="form-row">
      <label for="id_password2">Repeat Password</label>
      {{ form.password2 }}
      {% if form.password2.errors %}
        <ul class="twofactor-messages">
          {% for e in form.password2.errors %}<li>{{ e }}</li>{% endfor %}
        </ul>
      {% endif %}
    </div>

    {% if form.non_field_errors %}
      <ul class="twofactor-messages">
        {% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}
      </ul>
    {% endif %}

    <button type="submit">Create Account</button>
    <p class="hint" style="margin-top:0.75rem;">
      Already have an account? <a href="{% url 'two_factor:login' %}">Login</a>.
    </p>
  </form>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
(function() {
  const input = document.getElementById('id_username');
  if (!input) return;
  const status = document.getElementById('username_status');

  let last = '';
  let timer = null;
  function setStatus(msg, cls) {
    status.textContent = msg || '';
    status.className = 'hint ' + (cls || '');
  }
  function check() {
    const v = (input.value || '').trim();
    if (!v) {
      setStatus('');
      return;
    }
    if (v === last) return;
    last = v;
    setStatus('Checking…', '');
    fetch(`/accounts/check-username/?u=${encodeURIComponent(v)}`, {
      headers: { 'Accept': 'application/json' }
    }).then(r => r.json().catch(() => ({}))).then(data => {
      if (!data) return;
      if (data.available) {
        setStatus('Available ✔', 'ok');
      } else {
        setStatus('Taken ✖', 'bad');
      }
    }).catch(() => {});
  }
  input.addEventListener('input', () => {
    clearTimeout(timer);
    timer = setTimeout(check, 250);
  });
})();
</script>
<style>
  .twofactor-wrapper {
    max-width: 28rem;
    padding: 1.25rem 1.5rem 1.5rem;
    background: var(--panel-bg, rgba(255,255,255,0.03));
    border: 1px solid var(--border-color,#444);
    border-radius: 6px;
    font-size: 0.95rem;
  }
  .twofactor-wrapper form {
    display:flex;
    flex-direction:column;
    gap:0.85rem;
    margin-top:0.25rem;
  }
  .twofactor-messages {
    margin:0.25rem 0 0.5rem;
    color:#d66;
    font-size:0.85rem;
    padding-left:1.1rem;
  }
  .twofactor-messages li { list-style:disc; }
  #username_status.ok { color:#5c5; }
  #username_status.bad { color:#d66; }
  .form-row {
    display:flex;
    flex-direction:column;
  }
  .form-row input[type="text"],
  .form-row input[type="password"] {
    max-width:22rem;
  }
</style>
{% endblock %}
