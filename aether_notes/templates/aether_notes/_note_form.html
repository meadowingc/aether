{# Reusable note form partial. Expects variables: form_action, note_text, submit_label, show_save_draft, is_edit, errors, device_id, user, profile, crosspost fields, etc. #}
<form class="note-form" action="{{ form_action }}" method="post">
  {% csrf_token %}
  <label class="sr-only" for="note_text">Note</label>
  <textarea id="note_text" name="text" rows="3" maxlength="2000" placeholder="Go on, throw it into the voidâ€¦" required autocomplete="off">{{ note_text|default_if_none:"" }}</textarea>
  <div class="counter-row">
    <span id="note_counter" class="char-counter">0/2000</span>
    {% if user.is_authenticated and profile %}
      {% with p=profile %}
        <div class="network-counters">
          {% if p.crosspost_mastodon and p.mastodon_instance and p.mastodon_token %}
            <label class="net-toggle">
              <input type="checkbox" name="xp_mastodon" id="xp_mastodon" checked>
              <span>Mastodon</span>
              <span id="mastodon_counter" class="char-counter small" data-limit="{{ p.mastodon_char_limit|default:2000 }}">0/{{ p.mastodon_char_limit|default:2000 }}</span>
            </label>
          {% endif %}
          {% if p.crosspost_bluesky and p.bluesky_handle and p.bluesky_app_password %}
            <label class="net-toggle">
              <input type="checkbox" name="xp_bluesky" id="xp_bluesky" checked>
              <span>Bluesky</span>
              <span id="bluesky_counter" class="char-counter small" data-limit="300">0/300</span>
            </label>
          {% endif %}
          {% if p.crosspost_status_cafe and p.status_cafe_username and p.status_cafe_password %}
            <label class="net-toggle">
              <input type="checkbox" name="xp_status_cafe" id="xp_status_cafe" checked>
              <span>Status.cafe</span>
              <span id="status_cafe_counter" class="char-counter small" data-limit="140">0/140</span>
              <span class="face-picker-wrap" style="display:inline-flex; align-items:center; gap:4px;">
                <input type="hidden" name="xp_status_cafe_face" id="xp_status_cafe_face" value="">
                <button type="button" id="face_display_btn" class="face-emoji-btn" aria-haspopup="dialog" aria-expanded="false" aria-controls="face_picker_popup" title="Pick an emoji" data-default="ðŸ™‚">ðŸ™‚</button>
              </span>
            </label>
          {% endif %}
        </div>
      {% endwith %}
    {% endif %}
  </div>
  <div class="form-row">
    {% if not user.is_authenticated %}
      <label class="sr-only" for="note_author">Author (optional)</label>
      <input type="text" id="note_author" name="author" placeholder="Your name (optional)" maxlength="25" autocomplete="off" aria-describedby="author_status">
      <span id="author_status" class="hint" role="alert" style="margin-left:.5rem;"></span>
      <input type="hidden" id="note_device_id" name="device_id" value="{{ device_id|default_if_none:"" }}">
      <label class="remember"><input type="checkbox" id="remember_author"> Remember</label>
    {% else %}
      <input type="hidden" id="note_device_id" name="device_id" value="{{ device_id|default_if_none:"" }}">
      <p class="hint">Posting as <strong>{{ user.username }}</strong></p>
    {% endif %}
    <button type="submit" name="throw">{% if submit_label %}{{ submit_label }}{% else %}Throw{% endif %}</button>
    {% if show_save_draft %}
      <button type="submit" name="save_draft" value="1" formnovalidate>Save as draft</button>
    {% endif %}
    {% if is_edit %}
      <button type="submit" name="save_changes" formnovalidate>Save changes</button>
    {% endif %}
  </div>
  {% if errors %}
    <p class="error">{{ errors }}</p>
  {% endif %}
  <p class="hint">{% if is_edit %}Edit your draft. You can save changes or throw it.{% else %}Public for ~48 hours. Please avoid personal info.{% endif %}</p>
</form>
