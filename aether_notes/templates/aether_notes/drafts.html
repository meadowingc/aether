{% extends "aether_notes/base.html" %}
{% block title %}Drafts{% endblock %}

{% block content %}
  <h2>Your Drafts</h2>
  {% if drafts %}
    <section class="soup">
      {% for draft in drafts %}
        <article
          class="note-card"
          data-note-id="{{ draft.pk }}"
          data-created-by="{{ draft.created_device_id|default:'' }}"
          data-created-by-user="{{ draft.user.username|default:'' }}"
        >
          <div class="note-text">{{ draft.text }}</div>
          <footer class="note-meta">
            <span class="draft-date">{{ draft.last_modified|date:"Y-m-d H:i" }}</span>
            <span class="dot">•</span>
            <a href="{% url 'edit_draft' draft.pk %}">Edit</a>
            <span class="del-wrap">
              <span class="dot">•</span>
              <a href="#" class="note-del" title="Delete this note" aria-label="Delete">del</a>
            </span>
          </footer>
        </article>
      {% endfor %}
    </section>
  {% else %}
    <p class="empty">You have no drafts.</p>
  {% endif %}

    <script>
    // Local storage for author and prepare device id field
    (function() {
        // CSRF helper (Django docs)
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        function onClick(e) {
          const link = e.target.closest('.note-del');
          if (!link) return;
          e.preventDefault();

          const card = link.closest('.note-card');
          const id = card && parseInt(card.dataset.noteId, 10);
          if (!id) return;

          if (!confirm('Delete this note? This cannot be undone.')) return;

          fetch('{% url "delete_note" %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({ note_id: String(id), device_id: "na" })
          }).then(r => r.json().catch(() => ({}))).then(data => {
            if (data && data.ok) {
              card.remove();
            } else if (data && data.error === 'forbidden') {
              alert(data.message);
            } else if (data && data.error === 'not_found') {
              card.remove();
            } else {
              alert('Failed to delete. Please try again.');
            }
          }).catch(() => alert('Failed to delete. Please try again.'));
        }
        document.addEventListener('click', onClick);
    })();
    </script>
{% endblock %}
