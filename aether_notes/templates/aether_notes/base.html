{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üåå</text></svg>"
    />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="robots" content="noindex, noarchive" />
    <script>
      // Apply saved theme or default to dark as early as possible to avoid flashes
      (function () {
        try {
          var t = localStorage.getItem("aether_theme");
          document.documentElement.setAttribute(
            "data-theme",
            t === "light" || t === "dark" ? t : "dark"
          );
        } catch (e) {
          // If localStorage is not accessible, still default to dark
          document.documentElement.setAttribute("data-theme", "dark");
        }
      })();
    </script>
    <link rel="stylesheet" href="{% static 'aether_notes/style.css' %}" />
    <title>{% block title %}Aether{% endblock %}</title>
    {% block extra_head %}{% endblock %}
  </head>
  <body>
    <header class="site-header">
      <h1><a href="{% url 'index' %}">üåå Aether</a></h1>
      <div class="header-actions">
        <button
          id="theme_toggle"
          class="theme-toggle"
          aria-label="Toggle theme"
          title="Toggle theme"
        >
          üåô
        </button>

        <!-- Mobile menu toggle (shown on narrow viewports) -->
        <button
          id="nav_toggle"
          class="nav-toggle"
          aria-label="Open menu"
          aria-controls="nav_menu"
          aria-expanded="false"
          title="Menu"
        >‚ò∞</button>

        <!-- Inline header links (shown on wider viewports) -->
        <nav class="header-links" role="navigation" aria-label="Header links">
        {% if request.user.is_authenticated %}
          {% if request.user.profile.show_archive %}
            <a class="user-pill" href="{% url 'accounts:user_archive' request.user.username %}">üë§ {{ request.user.username }}</a>
          {% else %}
            <span class="user-pill">üë§ {{ request.user.username }}</span>
          {% endif %}
          <a class="about-link" href="{% url 'drafts_list' %}">Drafts</a>
          <a class="about-link" href="{% url 'accounts:settings' %}">Settings</a>
          <a class="about-link" href="{% url 'logout' %}">Logout</a>
        {% else %}
          <a class="about-link" href="{% url 'about' %}">About</a>
          <a class="about-link" href="{% url 'two_factor:login' %}">Login</a>
          <a class="about-link" href="{% url 'accounts:register' %}">Register</a>
        {% endif %}
        </nav>

        <!-- Collapsed mobile menu (duplicated links for small viewports) -->
        <div id="nav_menu" class="mobile-menu" hidden aria-hidden="true">
          <div class="mobile-menu-inner">
          {% if request.user.is_authenticated %}
            {% if request.user.profile.show_archive %}
              <a class="mobile-user" href="{% url 'accounts:user_archive' request.user.username %}">üë§ {{ request.user.username }}</a>
            {% else %}
              <span class="mobile-user">üë§ {{ request.user.username }}</span>
            {% endif %}
            <a class="mobile-link" href="{% url 'drafts_list' %}">Drafts</a>
            <a class="mobile-link" href="{% url 'accounts:settings' %}">Settings</a>
            <a class="mobile-link" href="{% url 'logout' %}">Logout</a>
          {% else %}
            <a class="mobile-link" href="{% url 'about' %}">About</a>
            <a class="mobile-link" href="{% url 'two_factor:login' %}">Login</a>
            <a class="mobile-link" href="{% url 'accounts:register' %}">Register</a>
          {% endif %}
          </div>
        </div>
      </div>
    </header>

    {% if messages %}
    <div class="messages">
      <ul>
        {% for m in messages %}
          <li class="msg {{ m.tags }}">{{ m }}</li>
        {% endfor %}
      </ul>
    </div>
    {% endif %}
    <main class="container">{% block content %}{% endblock %}</main>
    <script>
      (function () {
        var btn = document.getElementById("theme_toggle");
        if (!btn) return;
        function current() {
          return document.documentElement.getAttribute("data-theme") || "dark";
        }
        function setTheme(t) {
          document.documentElement.setAttribute("data-theme", t);
          try {
            localStorage.setItem("aether_theme", t);
          } catch (e) {}
          btn.textContent = t === "dark" ? "üåô" : "‚òÄÔ∏è";
        }
        // init icon
        setTheme(current());
        btn.addEventListener("click", function () {
          setTheme(current() === "dark" ? "light" : "dark");
        });
      })();

      // Mobile header menu toggle
      (function() {
        const toggle = document.getElementById('nav_toggle');
        const menu = document.getElementById('nav_menu');

        if (!toggle || !menu) return;

        function openMenu() {
          toggle.setAttribute('aria-expanded', 'true');
          menu.hidden = false;
          menu.setAttribute('aria-hidden', 'false');
          // focus first link inside menu for a11y
          const f = menu.querySelector('a, button, [tabindex]:not([tabindex="-1"])');
          if (f) f.focus();
          document.addEventListener('keydown', onKey);
          document.addEventListener('click', onDocClick, true);
        }
        function closeMenu(returnFocus=true) {
          toggle.setAttribute('aria-expanded', 'false');
          menu.hidden = true;
          menu.setAttribute('aria-hidden', 'true');
          if (returnFocus) toggle.focus();
          document.removeEventListener('keydown', onKey);
          document.removeEventListener('click', onDocClick, true);
        }

        function onKey(e) {
          if (e.key === 'Escape') closeMenu();
        }
        function onDocClick(e) {
          if (menu.contains(e.target) || e.target === toggle) return;
          closeMenu(false);
        }

        toggle.addEventListener('click', function(e) {
          const expanded = toggle.getAttribute('aria-expanded') === 'true';
          if (expanded) closeMenu();
          else openMenu();
        });
      })();
    </script>
    {% block scripts %}{% endblock %}
  </body>
</html>
