{% extends "aether_notes/base.html" %}
{% load static %}

{% block title %}Aether{% endblock %}

{% block content %}
  {% url 'create_note' as form_action %}
  {% include "aether_notes/_note_form.html" with form_action=form_action note_text="" submit_label="Throw" show_save_draft=request.user.is_authenticated is_edit=False errors=None device_id="" user=request.user profile=request.user.profile|default_if_none:"" %}

  {% if latest_note_list %}
    <section id="soup" class="soup">
      {% for note in latest_note_list %}
        <article
            class="note-card"
            data-note-id="{{ note.id }}"
            data-created-by="{{ note.created_device_id|default:'' }}"
            data-created-by-user="{{ note.user.username|default:'' }}"
            style="opacity: {{ note.opacity|default:1 }};" >
          <div class="note-text">{{ note.text|urlize|linebreaksbr }}</div>
          <footer class="note-meta">
            {% if note.user %}
              {% if note.user.profile.show_archive %}
                <a class="author" href="{% url 'accounts:user_archive' note.user.username %}">{{ note.user.username }}</a>
              {% elif note.user.profile.website %}
                <a class="author" href="{{ note.user.profile.website }}" target="_blank" rel="noopener nofollow">{{ note.user.username }}</a>
              {% else %}
                <span class="author">{{ note.user.username }}</span>
              {% endif %}
            {% else %}
              <span class="author">{{ note.author|default:"anonymous" }}</span>
            {% endif %}
            <span class="dot">•</span>
            <span class="expires">fades in {{ note.expires_in }}</span>
            <span class="dot">•</span>
            <span class="views" data-views>{{ note.views }}{% if note.views == 1 %} witness{% else %} witnessed{% endif %}</span>
            <span class="del-wrap" style="display:none">
                <span class="dot">•</span>
                <a href="#" class="note-del" title="Delete this note" aria-label="Delete">del</a>
            </span>
            <span class="dot">•</span>
            <button type="button" class="flag-btn" aria-label="Flag this note as inappropriate" title="Flag this note as inappropriate">⚑</button>
          </footer>
          {% with cps=note.crossposts.all %}
            {% if cps %}
              <div class="xp-row">
                X-Posted to:
                {% for cp in cps %}
                  {% if cp.network == 'mastodon' and cp.remote_url %}<a href="{{ cp.remote_url }}" class="xp xp-mstn" target="_blank" rel="noopener" title="View on Mastodon">(mstn)</a>{% endif %}
                  {% if cp.network == 'bluesky' and cp.remote_url %}<a href="{{ cp.remote_url }}" class="xp xp-bsky" target="_blank" rel="noopener" title="View on Bluesky">(bsky)</a>{% endif %}
                {% endfor %}
              </div>
            {% endif %}
          {% endwith %}
        </article>
      {% endfor %}
    </section>
  {% else %}
      <p class="empty">The void is quiet. Be the first to speak.</p>
  {% endif %}
{% endblock content %}

{% block scripts %}
  <script>
    // Lightweight device id for unique witness tracking
    function getDeviceId() {
        let id = localStorage.getItem('aether_device_id');
        if (!id) {
            id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
            localStorage.setItem('aether_device_id', id);
        }
        return id;
    }

    // IntersectionObserver: count a witness when a card is actually seen.
    function setupWitnessObserver() {
        const seenKey = id => `aether_seen_${id}`;
        const io = new IntersectionObserver(entries => {
            for (const entry of entries) {
                if (!entry.isIntersecting) continue;
                const card = entry.target;
                const id = parseInt(card.dataset.noteId, 10);
                if (!id || localStorage.getItem(seenKey(id))) {
                    io.unobserve(card);
                    continue;
                }
                // Mark locally to avoid duplicate posts even if server dedupes.
                localStorage.setItem(seenKey(id), '1');
                io.unobserve(card);

                // Fire-and-forget witness hit
                fetch('{% url "witness" %}', {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                  },
                  body: new URLSearchParams({ note_id: String(id), device_id: getDeviceId() })
                }).then(r => r.ok ? r.json() : null).then(data => {
                  if (!data || !data.ok) return;

                  const el = card.querySelector('[data-views]');
                  if (!el) return;

                  const count = data.views;
                  if (typeof count === 'number') {
                    el.textContent = `${count}${count === 1 ? ' witness' : ' witnessed'}`;
                  }
                }).catch(() => {});
            }
        }, { threshold: 0.6 });

        document.querySelectorAll('.note-card').forEach(card => io.observe(card));
    }

    // CSRF helper (Django docs)
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // Run once on load
    setupWitnessObserver();

    // Delete note handler — only succeeds if device owns the note
    (function() {
        // Make autolinked URLs open safely in a new tab
        document.querySelectorAll('.note-card .note-text a').forEach(a => {
          a.target = '_blank';
          a.rel = 'noopener noreferrer';
        });
        // Show delete link only on owned notes
        const myId = getDeviceId();
        document.querySelectorAll('.note-card').forEach(card => {
          // username takes precedence if user is currently logged in
          const currentUsername = {% if request.user.is_authenticated %}"{{ request.user.username }}"{% else %}undefined{% endif %};
          const ownerUsername = card.getAttribute('data-created-by-user') || '';
          const ownerDeviceId = card.getAttribute('data-created-by') || '';
          const wrap = card.querySelector('.del-wrap');
          if (wrap && (ownerUsername && ownerUsername === currentUsername) || (ownerDeviceId && ownerDeviceId === myId)) {
            wrap.style.display = '';
          }
        });

        function onClick(e) {
          const link = e.target.closest('.note-del');
          if (!link) return;
          e.preventDefault();

          const card = link.closest('.note-card');
          const id = card && parseInt(card.dataset.noteId, 10);
          if (!id) return;

          if (!confirm('Delete this note? This cannot be undone.')) return;

          fetch('{% url "delete_note" %}', {
            method: 'POST',
            headers: {
              'X-CSRFToken': getCookie('csrftoken')
            },
            body: new URLSearchParams({ note_id: String(id), device_id: getDeviceId() })
          }).then(r => r.json().catch(() => ({}))).then(data => {
            if (data && data.ok) {
              card.remove();
            } else if (data && data.error === 'forbidden') {
              alert(data.message);
            } else if (data && data.error === 'not_found') {
              card.remove();
            } else {
              alert('Failed to delete. Please try again.');
            }
          }).catch(() => alert('Failed to delete. Please try again.'));
        }
        document.addEventListener('click', onClick);
    })();

    // Flag handler — one flag per device
    (function() {
      function markInitialFlags() {
        document.querySelectorAll('.note-card').forEach(card => {
          const id = parseInt(card.dataset.noteId, 10);
          if (!id) return;
          if (localStorage.getItem(`aether_flagged_${id}`)) {
            const btn = card.querySelector('.flag-btn');
            if (btn) btn.classList.add('flagged');
          }
        });
      }
      function onClickFlag(e) {
        const btn = e.target.closest('.flag-btn');
        if (!btn) return;
        const card = btn.closest('.note-card');
        const id = card && parseInt(card.dataset.noteId, 10);
        if (!id) return;

        fetch('{% url "flag_note" %}', {
          method: 'POST',
          headers: { 'X-CSRFToken': getCookie('csrftoken') },
          body: new URLSearchParams({ note_id: String(id), device_id: getDeviceId() })
        }).then(r => r.json().catch(() => ({}))).then(data => {
          if (data && data.ok) {
            if (data.flagged) {
              btn.classList.add('flagged');
              if (typeof data.flags === 'number') {
                btn.title = `Flagged (${data.flags})`;
              } else {
                btn.title = 'Flagged';
              }
              localStorage.setItem(`aether_flagged_${id}`, '1');
            } else {
              btn.classList.remove('flagged');
              if (typeof data.flags === 'number') {
                btn.title = `Flag (${data.flags})`;
              } else {
                btn.title = 'Flag';
              }
              localStorage.removeItem(`aether_flagged_${id}`);
            }
          }
        }).catch(() => {});
      }
      document.addEventListener('click', onClickFlag);
      // initialize
      markInitialFlags();
    })();
  </script>
  <link rel="stylesheet" href="{% static 'aether_notes/shared.css' %}">
{% endblock scripts %}
